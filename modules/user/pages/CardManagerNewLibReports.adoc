=  Добавление отчетов

Отчёты – хранимые процедуры БД, которые могут использоваться для прямого обращения к БД минуя объектную модель и средства безопасности {dv}. Использования отчётов позволяет (в некоторых случаях) ускорить доступ к данным, получить сложную выборку данных, получить данные из сторонней базы данных или сервера и т.п.

[NOTE]
====
[.note__title]#Important:# Методы, предоставляемые отчетами, выполняются вне моделей безопасности {dv}, поэтому программист должен самостоятельно обеспечить необходимые ограничения.
====

Хранимая процедура отчет имеет определенный набор входных и выходных параметров, а также уникальный идентификатор, по которому данный отчет может быть вызван.

Ниже приведён код примера отчёта для Microsoft SQL и PostgreSQL, возвращающего список замещаемых сотрудников, для которых `@EmployeeID` указан заместителем в Справочнике сотрудников.

[source,pre,codeblock]
----
-- Версия для СУБД Microsoft SQL
BEGIN
 SELECT [RowID], [ParentRowID], [IsNotified]
 FROM  [dbo].[dvtable_{ED414CB4-B205-4BE4-A2FA-5C0D3347CEB3}] WITH(NOLOCK)
 WHERE [DeputyID] = @EmployeeID
END
–- конец

-- Версия для СУБД PostgreSQL
$$
BEGIN
    RETURN query
    SELECT tDeputies."RowID", tDeputies."ParentRowID", tDeputies."IsNotified"::integer
    FROM  public."dvtable_{ed414cb4-b205-4be4-a2fa-5c0d3347ceb3}" tDeputies
    WHERE tDeputies."DeputyID" = val_EmployeeID;
END;
$$
LANGUAGE plpgsql volatile;
– конец
----

Чтобы добавить новый отчет в библиотеку карточек:

. Создайте файл отчета с хранимой процедурой (пример приведен выше) для Microsoft SQL и/или PostgreSQL (в зависимости от целевой СУБД).
+
Файл(ы) нужно разместить в одном каталоге (или в подкаталоге) с файлом схемы библиотеки карточек.
. Откройте настройки библиотеки карточек ([.ph .menucascade]#*Edit* > *Library Properties*#).
. Перейдите на страницу настройки отчетов [.keyword .wintitle]*Reports*.
+
image::CardManagerLibReports.png[Страница настройки отчетов]

Настройте основные параметры отчета.

[start=4]
. Нажмите кнопку [.kbd .ph .userinput]`Add` в разделе [.keyword .wintitle]*Procedures*. В список *Procedures* будет добавлена новая запись.
. В поле [.kbd .ph .userinput]`Alias` введите псевдоним отчета, по которому данный отчет может быть вызван с помощью API {dv}.
. В таблице [.kbd .ph .userinput]`Названия` введите локализованные названия отчета.
+
image::CardManagerNewReportFirstSection.png[Пример настройки основных параметров отчета]

Укажите SQL-файлы c разработанными хранимыми процедурами.

[start=7]
. На странице [.keyword .wintitle]*Reports* откройте вкладку [.keyword .wintitle]*SQL files* .
. Нажмите на кнопку *Add* на вкладке [.keyword .wintitle]*SQL files*. В список *Files* будет добавлена новая запись.
. В поле [.kbd .ph .userinput]`SQL file` выберите SQL-файл, содержащий хранимую процедуру. После добавления путь необходимо изменить на относительный (относительно файла схемы библиотеки карточек).
. В поле [.kbd .ph .userinput]`Server type` выберите тип СУБД, для которой предназначен файл: Microsoft SQL или PostgreSQL.
+
[NOTE]
====
[.note__title]#Note:# Типы СУБД Oracle и MySQL, представленные в списке, не поддерживаются системой {dv} 5.
====
. Если требуется ограничить применение SQL-файла версией СУБД, укажите её в поле [.kbd .ph .userinput]`Server version`.
+
Если версия не указана, хранимая процедура может быть загружена в БД, работающую под управлением СУБД любой версии.
+
image::CardManagerNewReportFilesSection.png[Пример настройки файлов отчета]
. Если требуется, добавьте аналогичным образом другие файлы отчетов.

Если хранимая процедура принимает входящие параметры, настройте их на вкладке [.keyword .wintitle]*Parameters*.

[start=13]
. На странице [.keyword .wintitle]*Reports* откройте вкладку [.keyword .wintitle]*Parameters*.
. Нажмите на кнопку *Add*. В список *Parameters* будет добавлена новая запись.
. В поле [.kbd .ph .userinput]`Parameter name` введите название параметра, принимаемого хранимой процедурой.
. Выберите тип параметра в списке [.kbd .ph .userinput]`Parameter type`.
+
image::CardManagerNewReportParametersSection.png[Пример настройки параметров отчета]
. Если требуется, аналогичным образом добавьте другие параметры хранимой процедуры.

Если хранимая процедура возвращает значения, настройте их на вкладке [.keyword .wintitle]*Report result*.

[start=18]
. На странице [.keyword .wintitle]*Reports* откройте вкладку [.keyword .wintitle]*Report result*.
. Выберите формат возвращаемого значения:#
* *Scalar result* – если хранимая процедура возвращает единичное значение;
* *TableResult* – если хранимая процедура возвращает набор значений.
. Для варианта "Scalar result":#
[loweralpha]
.. Выберите тип возвращаемого значения в списке *Data type*.
.. Настройте значения: *Precision* и *Scale* (только для полей с плавающей точкой), *Size* (максимальный размер), *Nullable* (может быть пустым).
.. Нажмите кнопку *Add*. В таблицу *Columns* будет добавлена новая запись.
. Для варианта "TableResult":#
[loweralpha]
.. Нажмите на кнопку *Add* на вкладке [.keyword .wintitle]*Report result*. В таблицу *Columns* будет добавлена новая запись.
.. Введите название колонки с возвращаемым значением в поле [.kbd .ph .userinput]`Name`.
.. Выберите тип возвращаемого значения в списке *Data type*.
.. Настройте параметры: *Precision* и *Scale*, *Size*, *Nullable*.
.. Если требуется, аналогичным образом настройте параметры других возвращаемых колонок.
+
image::CardManagerNewReportResultsSection.png[Пример настройки параметров возвращаемого значения]

*Parent topic:* xref:../pages/cardmanager_createlibrary.adoc[Создание новой библиотеки карточек]
